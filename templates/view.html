<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>View</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-sidebar: #f8f9fa;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-color: #cccccc;
            --active-item: #0d6efd;
            --button-bg: #007bff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #121212;
                --bg-sidebar: #252526;
                --text-primary: #ffffff;
                --text-secondary: #e0e0e0;
                --border-color: #444444;
                --active-item: #0d6efd;
                --button-bg: #0d6efd;
            }
        }

        body {
            display: flex;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace;
            height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        #sidebar {
            width: 260px;
            padding: 0;
            background: var(--bg-sidebar);
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        #sidebar > div:not(:first-child) {
            padding: 8px 16px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #sidebar > div:not(:first-child):hover {
            background: rgba(0,0,0,0.1);
        }

        #sidebar > div.active {
            background: var(--active-item);
            color: white;
        }

        #preview {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        #preview img {
            max-width: 98vw;
            max-height: 98vh;
            object-fit: contain;
        }

        #preview .loading {
            color: #aaa;
            font-family: monospace;
        }

        #error {
            color: #ff6b6b;
            padding: 20px;
            font-family: monospace;
            display: none;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
        <button id="backBtn" style="
            width: 100%;
            padding: 6px 0;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: normal;
        ">← Back to Gallery</button>
    </div>
</div>
<div id="preview">
    <div class="loading">Loading...</div>
</div>
<div id="error"></div>

<script>
let initialLoad = true;
let currentFileListFull = [];
let currentPayload = null;

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
    document.querySelector('#preview .loading').style.display = 'none';
}

function hideError() {
    document.getElementById('error').style.display = 'none';
}

function updateSidebarByFullPath(fullPath) {
    const sidebar = document.getElementById('sidebar');
    const backButtonContainer = sidebar.firstElementChild;
    sidebar.innerHTML = '';
    if (backButtonContainer) {
        sidebar.appendChild(backButtonContainer);
    }

    currentFileListFull.forEach(fp => {
        const el = document.createElement('div');
        el.textContent = fp.replace(/\\/g, '/').split('/').pop();
        if (fp.toLowerCase() === fullPath.toLowerCase()) {
            el.classList.add('active');
            if (initialLoad) {
                setTimeout(() => el.scrollIntoView({ block: 'nearest' }), 10);
            }
        }
        el.onclick = () => switchToImageByPath(fp);
        sidebar.appendChild(el);
    });
}

async function loadImageByPath(fullPath) {
    hideError();
    const preview = document.getElementById('preview');
    preview.innerHTML = '<div class="loading">Loading image...</div>';

    try {
        const payload = { ...currentPayload, full_path: fullPath };
        const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        const res = await fetch(`/api/view?data=${encodeURIComponent(b64)}`);
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();

        document.title = `View: ${data.filename}`;

        preview.innerHTML = '';
        const img = document.createElement('img');
        img.src = data.image_url + '?t=' + Date.now();
        img.alt = data.full_path;
        img.title = data.full_path;
        preview.appendChild(img);

        currentFileListFull = data.file_list_full;
        currentPayload = JSON.parse(atob(data.encoded_data));
        updateSidebarByFullPath(data.full_path);

        // Настройка кнопки "Назад"
        const { folder, regex, save } = currentPayload;
        const url = new URL('/', window.location.origin);
        if (folder) url.searchParams.set('path', folder);
        if (regex) url.searchParams.set('regex', regex);
        if (save) url.searchParams.set('save', 'true');
        document.getElementById('backBtn').onclick = () => {
            window.location.href = url.toString();
        };

    } catch (err) {
        showError("Failed to load image: " + err.message);
    }
}

function switchToImageByPath(fullPath) {
    const filename = fullPath.replace(/\\/g, '/').split('/').pop();
    const newPayload = { ...currentPayload, full_path: fullPath };
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(newPayload))));
    history.pushState(null, '', `/view/${b64}`);
    document.title = `View: ${filename}`;
    initialLoad = false;
    loadImageByPath(fullPath);
}

(async () => {
    const urlParts = window.location.pathname.split('/');
    const b64Data = urlParts[urlParts.length - 1];

    if (!b64Data) {
        showError("No view data in URL");
        return;
    }

    try {
        const res = await fetch(`/api/view?data=${encodeURIComponent(b64Data)}`);
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();

        currentFileListFull = data.file_list_full;
        currentPayload = JSON.parse(atob(data.encoded_data));

        updateSidebarByFullPath(data.full_path);
        loadImageByPath(data.full_path);
        initialLoad = false;

    } catch (err) {
        showError("Initial load failed: " + err.message);
    }
})();

window.addEventListener('popstate', () => {
    const urlParts = window.location.pathname.split('/');
    const b64Data = urlParts[urlParts.length - 1];
    if (b64Data) {
        window.location.reload();
    }
});
</script>

</body>
</html>